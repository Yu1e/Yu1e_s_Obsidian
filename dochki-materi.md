<%*
/*
–®–∞–±–ª–æ–Ω Templater –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –∑–∞–º–µ—Ç–∫—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∑–∞–º–µ—Ç–∫–∏ —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É –≤ –∑–∞–º–µ—Ç–∫–µ.
–¢.–µ. –¥–µ–ª–∞–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–º–µ—Ç–∫—É, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–ª–∏–∫–æ–º ‚Äî –ø–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞. –ê –∫ –Ω–µ–π –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
—ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω –∏ –≤—Å—Ç–∞–≤–ª—è–µ—Ç –≤ —Ç–µ–ª–æ —Ç–µ–∫—É—â–µ–π –∑–∞–º–µ—Ç–∫–∏ —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞: –ü—Ä–µ–¥—ã–¥—É—â–∞—è/–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è: [[—Å—Å—ã–ª–∫–∞ —Å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º –∞–ª–∏–∞—Å–æ–º]]
–ß–∞—Ç: https://www.perplexity.ai/search/pri-sozdanii-novoi-zametki-che-_8jkjUpcRP.Lb5HjwS3fhA
- [ ] –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã: –æ—Ç–∫—Ä—ã—Ç–æ –º–Ω–æ–≥–æ –∑–∞–º–µ—Ç–æ–∫, –∏–∑–≤–ª—ë–∫ —Ç—É, –∫–æ—Ç–æ—Ä–∞—è –≤ "–æ—Å–Ω–æ–≤–Ω–æ–º" –æ–∫–Ω–µ, –∞ –Ω–µ –≤ –±–æ–∫–æ–≤—É—à–∫–∞—Ö. –ù–µ–∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ...
*/

// ===== –ë–ª–æ–∫ 0. –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è –ù–∞–∫–æ–ø–∏—Ç–µ–ª—è =====
// –í–ê–ñ–ù–û: –≤–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å —Ç–æ—á–Ω–æ–µ –∏–º—è –ø–∞–ø–∫–∏-–ò–Ω–±–æ–∫—Å–∞ (–∫–∞–∫ –≤ –¥–µ—Ä–µ–≤–µ):
const INBOX_FOLDER = "–í–°–Å_–û–°–¢–ê–õ–¨–ù–û–ï/–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å";

// ===== –ë–ª–æ–∫ 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –∏ ¬´—Ä–æ–¥–∏—Ç–µ–ª—è¬ª =====
const currentPath = tp.file.path(true); // –ø—É—Ç—å —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞)

// üìÇ –¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞ (–±–µ–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞)
// –ï—Å–ª–∏ –∑–∞–º–µ—Ç–∫–∞ –≤ –∫–æ—Ä–Ω–µ, currentFolder –±—É–¥–µ—Ç –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
const currentLastSlashIndex = currentPath.lastIndexOf("/");
const currentFolder =
  currentLastSlashIndex === -1
    ? ""
    : currentPath.substring(0, currentLastSlashIndex);

const lastOpenPath = app.workspace.getLastOpenFiles()?.[0]; // –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π —Ñ–∞–π–ª

let parentFile = null;
let parentLink = "";

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π —Ñ–∞–π–ª –∏ —á—Ç–æ —ç—Ç–æ –Ω–µ —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª.
if (lastOpenPath && lastOpenPath !== currentPath) {
  parentFile = tp.file.find_tfile(lastOpenPath);
}

// –ï—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º Markdown‚Äë—Å—Å—ã–ª–∫—É —Å —É—á—ë—Ç–æ–º –∞–ª–∏–∞—Å–æ–≤.
if (parentFile) {
  // –ë–∞–∑–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç Obsidian, –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∏–¥–∞ [[–ú–∞–º–∞—à–∞]] –∏–ª–∏ [[–ü–∞–ø–∫–∞/–ú–∞–º–∞—à–∞]]
  let rawLink = app.fileManager.generateMarkdownLink(
    parentFile,
    tp.file.folder(true)
  );

  // –ï—Å–ª–∏ –≤ —Å—Å—ã–ª–∫–µ —É–∂–µ –µ—Å—Ç—å –∞–ª–∏–∞—Å (–µ—Å—Ç—å —Å–∏–º–≤–æ–ª |), –Ω–∏—á–µ–≥–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.
  if (rawLink.includes("|")) {
    parentLink = rawLink;
  } else {
    // –í—ã—Ä–µ–∑–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ –ø—É—Ç–∏ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è –∞–ª–∏–∞—Å–∞.
    // 1) –£–±–∏—Ä–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ/–∫–æ–Ω–µ—á–Ω—ã–µ [[ ]]
    const inner = rawLink.slice(2, -2); // "–ú–∞–º–∞—à–∞" –∏–ª–∏ "–ü–∞–ø–∫–∞/–ú–∞–º–∞—à–∞"
    // 2) –ë–µ—Ä—ë–º —á–∞—Å—Ç—å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–ª—ç—à–∞
    const lastSlashIndex = inner.lastIndexOf("/");
    const fileWithExt =
      lastSlashIndex === -1 ? inner : inner.substring(lastSlashIndex + 1);
    // 3) –£–±–∏—Ä–∞–µ–º .md –≤ –∫–æ–Ω—Ü–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    const aliasBase = fileWithExt.endsWith(".md")
      ? fileWithExt.slice(0, -3)
      : fileWithExt;

    // –°–æ–±–∏—Ä–∞–µ–º —Å—Å—ã–ª–∫—É —Å –∞–ª–∏–∞—Å–æ–º:
    // [[–ú–∞–º–∞—à–∞|–ú–∞–º–∞—à–∞]] –∏–ª–∏ [[–ü–∞–ø–∫–∞/–ú–∞–º–∞—à–∞|–ú–∞–º–∞—à–∞]]
    parentLink = `[[${inner}|${aliasBase}]]`;
  }
}

// ===== –ë–ª–æ–∫ 2. –ï—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω ‚Äî —Ä–µ—à–∞–µ–º, –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –ª–∏ –¥–æ—á–∫—É =====
if (parentFile) {
  // –ü–æ–ª–Ω—ã–π –ø—É—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è: "–ü–∞–ø–∫–∞1/–ü–∞–ø–∫–∞2/–†–æ–¥–∏—Ç–µ–ª—å.md"
  const parentFullPath = parentFile.path;
  const lastSlashIndex = parentFullPath.lastIndexOf("/");

  // –ü–∞–ø–∫–∞ —Ä–æ–¥–∏—Ç–µ–ª—è (–±–µ–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞). –ï—Å–ª–∏ —Å–ª—ç—à–∞ –Ω–µ—Ç, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —Ä–æ–¥–∏—Ç–µ–ª—å –≤ –∫–æ—Ä–Ω–µ.
  const parentFolder =
    lastSlashIndex === -1 ? "" : parentFullPath.substring(0, lastSlashIndex);

  // –§—É–Ω–∫—Ü–∏—è-–ø–æ–º–æ—â–Ω–∏–∫: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –ª–µ–∂–∏—Ç –ª–∏ –ø—É—Ç—å –≤ –ù–∞–∫–æ–ø–∏—Ç–µ–ª–µ.
  const isInInbox = (path) => {
    if (!INBOX_FOLDER) return false;
    return path === INBOX_FOLDER || path.startsWith(INBOX_FOLDER + "/");
  };

  const parentInInbox = isInInbox(parentFolder || parentFullPath);

  // ‚úÖ –ì–ª–∞–≤–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫—É, –∞ –Ω–µ –ø—É—Ç—å —Ñ–∞–π–ª–∞
  const currentInInbox = isInInbox(currentFolder);

  // –ï—Å–ª–∏ –∏ —Ä–æ–¥–∏—Ç–µ–ª—å, –∏ —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –≤ –ù–∞–∫–æ–ø–∏—Ç–µ–ª–µ ‚Äî –ù–ï –ø–µ—Ä–µ–Ω–æ—Å–∏–º.
  const shouldSkipMove = parentInInbox && currentInInbox;

  if (!shouldSkipMove) {
    // –ò–º—è —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞ (–±–µ–∑ –ø—É—Ç–∏).
    const currentFileName = tp.file.title + ".md";

    // –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–π –∑–∞–º–µ—Ç–∫–∏: —Ç–∞ –∂–µ –ø–∞–ø–∫–∞, —á—Ç–æ –∏ —É —Ä–æ–¥–∏—Ç–µ–ª—è.
    const newPath = parentFolder
      ? `${parentFolder}/${currentFileName}`
      : currentFileName;

    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª, –µ—Å–ª–∏ –ø—É—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ.
    if (newPath !== currentPath) {
      await tp.file.move(newPath);
    }
  }
}
-%>
<%* if (parentLink) { -%>
–ü—Ä–µ–¥—ã–¥—É—â–∞—è / –†–æ–¥–∏—Ç–µ–ª—å / –ü—Ä–∏–≤—è–∑–∫–∞: <%- parentLink %>
<%* } -%>
<% tp.file.cursor() %>
