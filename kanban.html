<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–∞–Ω–±–∞–Ω</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;500&display=swap" rel="stylesheet">
    
    <script>
    /* ============================================
       –ë–õ–û–ö –î–ñ–ê–í–ê-1: –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–ù–ê–ó–í–ê–ù–ò–Ø)
       –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–±–∞–Ω–∞ –∏ –∫–æ–ª–æ–Ω–æ–∫
       ============================================ */
    const APPCONFIG = {
        title: 'üåÄ –°–∏–Ω–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å',
        columns: [
            { id: 'napadalo', title: 'üçÇ –ù–∞–ø–∞–¥–∞–ª–æ', order: 0 },
            { id: 'inprogress', title: 'ü™ö –í —Ä–∞–±–æ—Ç–µ', order: 1 },
            { id: 'done', title: '‚ú® –°–¥–µ–ª–∞–Ω–æ', order: 2 },
            { id: 'stuck', title: '‚û∞ –ü–æ–¥–≤–∏—Å–ª–æ', order: 3 },
            { id: 'someday', title: 'üîÆ –ö–æ–≥–¥–∞-–Ω–∏–±—É–¥—å', order: 4 }
        ],
        archiveAutoDeleteDays: 7
    };
    </script>
    
    <style>
/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-1: –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò –ò –°–ö–†–û–õ–õ–ë–ê–†
   ============================================ */
* {
    scrollbar-width: thin;
    scrollbar-color: rgba(99, 102, 241, 0.3) rgba(17, 24, 39, 0.5);
}

::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: rgba(17, 24, 39, 0.5);
    border-radius: 5px;
}

::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.3);
    border-radius: 5px;
    transition: background 0.3s ease;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(99, 102, 241, 0.5);
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-2: BODY –ò –û–°–ù–û–í–ù–û–ô –§–û–ù
   ============================================ */
body {
    margin: 0;
    font-family: 'Roboto Condensed', -apple-system, BlinkMacSystemFont, sans-serif;
    font-weight: 400;
    background: 
        radial-gradient(circle at 0% 0%, rgba(147, 51, 234, 0.35), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(59, 130, 246, 0.35), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(236, 72, 153, 0.32), transparent 55%),
        linear-gradient(135deg, #17132f 0%, #1c1638 12%, #241d4a 26%, #2c235a 40%, #362d6d 55%, #3e3580 70%, #463d90 85%, #4e459b 100%);
    background-attachment: fixed;
    color: #d1d5db;
    min-height: 100vh;
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-3: –®–ê–ü–ö–ê (HEADER)
   ============================================ */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 30px;
    background: rgba(15, 12, 25, 0.78);
    backdrop-filter: blur(14px);
    border-bottom: 1px solid rgba(129, 140, 248, 0.35);
    position: sticky;
    top: 0;
    z-index: 10;
}

header h1 {
    margin: 0;
    font-size: 27px;
    color: #e0e7ff;
    font-weight: 500;
}

header .buttons {
    display: flex;
    gap: 12px;
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-4: –ö–ù–û–ü–ö–ò (–û–ë–©–ò–ï –°–¢–ò–õ–ò)
   ============================================ */
button {
    border-radius: 6px;
    border: 1px solid rgba(99, 102, 241, 0.3);
    padding: 8px 14px;
    font-size: 15px;
    cursor: pointer;
    background: rgba(17, 24, 39, 0.75);
    color: #d1d5db;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    font-family: inherit;
    font-weight: 400;
}

button:hover {
    background: rgba(30, 64, 175, 0.7);
    border-color: rgba(129, 140, 248, 0.7);
    transform: translateY(-1px);
    box-shadow: 0 4px 14px rgba(129, 140, 248, 0.35);
}

button.secondary {
    background: rgba(17, 24, 39, 0.65);
    border-color: rgba(99, 102, 241, 0.25);
}

button.secondary:hover {
    background: rgba(30, 41, 59, 0.9);
    border-color: rgba(129, 140, 248, 0.5);
}

button.danger {
    background: rgba(127, 29, 29, 0.5);
    border-color: rgba(248, 113, 113, 0.5);
}

button.danger:hover {
    background: rgba(127, 29, 29, 0.7);
    border-color: rgba(248, 113, 113, 0.7);
}

button:disabled {
    opacity: 0.5;
    cursor: default;
}

/* –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —É–¥–∞–ª–µ–Ω–∏—è */
.undo-btn {
    background: rgba(127, 29, 29, 0.3);
    border-color: rgba(248, 113, 113, 0.3);
}

.undo-btn:hover:not(:disabled) {
    background: rgba(127, 29, 29, 0.5);
    border-color: rgba(248, 113, 113, 0.5);
}

.undo-btn:disabled {
    opacity: 0.4;
    cursor: default;
    transform: none;
    box-shadow: none;
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-5: MAIN –ò –î–û–°–ö–ê
   ============================================ */
main {
    padding: 18px 24px 30px;
    overflow-x: auto;
    min-height: calc(100vh - 100px);
}

.board {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    min-width: max-content;
    min-height: calc(100vh - 140px);
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-6: –ö–û–õ–û–ù–ö–ò
   ============================================ */
.column {
    background: rgba(17, 24, 39, 0.6);
    backdrop-filter: blur(14px);
    border: 1px solid rgba(129, 140, 248, 0.4);
    border-radius: 12px;
    padding: 12px;
    width: 320px;
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 160px);
    cursor: pointer;
}

.column-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 9px;
    pointer-events: none;
}

.column-title {
    font-size: 20px;
    font-weight: 500;
    color: #c7d2fe;
}

.column-count {
    font-size: 17px;
    color: #6b7280;
    font-weight: 300;
}

.column-body {
    flex: 1;
    overflow-y: auto;
    padding-right: 6px;
    display: flex;
    flex-direction: column;
    gap: 9px;
    pointer-events: auto;
}

.add-task-btn {
    margin-top: 9px;
    font-size: 14px;
    padding: 6px 10px;
    pointer-events: auto;
    background: rgba(30, 64, 175, 0.6);
    border-color: rgba(129, 140, 248, 0.6);
    color: #e0e7ff;
}

.add-task-btn:hover {
    background: rgba(37, 99, 235, 0.8);
}

/* –ö–æ–ª–æ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ –æ–±—ë—Ä—Ç–∫–∏ —Å done-box ‚Äî –∫–æ—Ä–æ—á–µ */
.done-wrapper .column {
    min-height: calc(100vh - 169px - 169px);
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-7: –ë–õ–û–ö "–°–î–ï–õ–ê–ù–û" (–ü–†–ê–ó–î–ù–ò–ß–ù–´–ô)
   ============================================ */
.done-wrapper {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.done-box {
    background: 
        radial-gradient(circle at 30% 30%, rgba(16, 185, 129, 0.25), transparent 60%),
        rgba(17, 24, 39, 0.75);
    backdrop-filter: blur(14px);
    border: 2px solid rgba(16, 185, 129, 0.5);
    border-radius: 12px;
    padding: 12px;
    width: 320px;
    height: 140px;
    overflow: hidden;
    position: relative;
    box-shadow: 
        0 0 20px rgba(16, 185, 129, 0.2),
        inset 0 0 30px rgba(16, 185, 129, 0.05);
}

.done-box::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(16, 185, 129, 0.03) 45%,
        rgba(16, 185, 129, 0.05) 50%,
        rgba(16, 185, 129, 0.03) 55%,
        transparent 60%
    );
    animation: done-shimmer 3s infinite linear;
    pointer-events: none;
}

@keyframes done-shimmer {
    0% { transform: translateX(-30%) translateY(-30%) rotate(45deg); }
    100% { transform: translateX(30%) translateY(30%) rotate(45deg); }
}

.done-box .column-header {
    pointer-events: none;
}

.done-box .column-title {
    color: #6ee7b7;
}

.done-box .column-body {
    flex: 1;
    overflow: hidden;
    pointer-events: auto;
}

.done-box .card {
    max-height: 100px;
    overflow: hidden;
}

/* –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ø–æ–¥–≤–∞–ª –ø–æ–¥ "–í —Ä–∞–±–æ—Ç–µ") */
.stats-box {
    background: 
        radial-gradient(circle at 30% 30%, rgba(99, 102, 241, 0.25), transparent 60%),
        rgba(17, 24, 39, 0.75);
    backdrop-filter: blur(14px);
    border: 2px solid rgba(99, 102, 241, 0.5);
    border-radius: 12px;
    padding: 12px;
    width: 320px;
    height: 100px;
    cursor: pointer;
    position: relative;
    box-shadow: 
        0 0 20px rgba(99, 102, 241, 0.2),
        inset 0 0 30px rgba(99, 102, 241, 0.05);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
}

.stats-box:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 0 30px rgba(99, 102, 241, 0.4),
        inset 0 0 40px rgba(99, 102, 241, 0.1);
}

.stats-box::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(99, 102, 241, 0.03) 45%,
        rgba(99, 102, 241, 0.05) 50%,
        rgba(99, 102, 241, 0.03) 55%,
        transparent 60%
    );
    animation: done-shimmer 3s infinite linear;
    pointer-events: none;
}

.stats-title {
    font-size: 14px;
    color: #a5b4fc;
    font-weight: 500;
    margin-bottom: 4px;
}

.stats-line {
    font-size: 13px;
    color: #d1d5db;
    font-weight: 300;
}

.inprogress-wrapper {
    display: flex;
    flex-direction: column;
    gap: 10px;
}


/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-8: –ö–ê–†–¢–û–ß–ö–ò –ó–ê–î–ê–ß
   ============================================ */
.card {
    background: rgba(30, 27, 75, 0.75);
    backdrop-filter: blur(10px);
    border-radius: 10px;
    border: 1px solid rgba(129, 140, 248, 0.4);
    padding: 9px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    cursor: grab;
    position: relative;
    transition: all 0.25s ease;
    pointer-events: auto;
}

.card:hover {
    transform: translateY(-2px);
    border-color: rgba(167, 139, 250, 0.8);
    box-shadow: 0 8px 24px rgba(129, 140, 248, 0.3);
}

.card.dragging {
    opacity: 0.6;
    border-style: dashed;
    box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.7);
}

.card-placeholder {
    border-radius: 10px;
    border: 1px dashed rgba(129, 140, 248, 0.7);
    background: rgba(30, 64, 175, 0.25);
    height: 60px;
    margin-bottom: 6px;
}

.done-box .card-placeholder {
    border-color: rgba(16, 185, 129, 0.7);
    background: rgba(16, 185, 129, 0.15);
}

.card.archiving {
    animation: card-archive 0.9s ease-out forwards;
}

@keyframes card-archive {
    0% { transform: scale(1); opacity: 1; }
    40% { transform: scale(1.04); opacity: 1; }
    100% { transform: scale(0.8) translateY(-18px); opacity: 0; }
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 6px;
}

.title {
    font-size: 17px;
    font-weight: 500;
    padding: 3px 4px;
    border-radius: 5px;
    min-height: 24px;
    flex: 1;
    color: #e5e7eb;
}

.title[contenteditable="true"]:empty::before,
.description[contenteditable="true"]:empty::before,
.tags[contenteditable="true"]:empty::before,
.subtask-text[contenteditable="true"]:empty::before {
    content: attr(data-placeholder);
    color: #4b5563;
    font-style: italic;
    pointer-events: none;
}

.title[contenteditable="true"]:focus,
.description[contenteditable="true"]:focus,
.tags[contenteditable="true"]:focus,
.subtask-text[contenteditable="true"]:focus {
    outline: 2px solid rgba(129, 140, 248, 0.65);
    background: rgba(30, 64, 175, 0.3);
}

.description {
    font-size: 15px;
    color: #9ca3af;
    padding: 3px 4px;
    border-radius: 5px;
    min-height: 22px;
    font-weight: 300;
}

/* –ö–æ–ª–æ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ –æ–±—ë—Ä—Ç–∫–∏ —Å–æ stats-box ‚Äî –∫–æ—Ä–æ—á–µ */
.inprogress-wrapper .column {
    min-height: calc(100vh - 180px - 120px);
}


/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-9: –ú–ï–¢–ê-–°–¢–†–û–ö–ê (–ü–†–ò–û–†–ò–¢–ï–¢, –î–ê–¢–ê, –¢–ï–ì–ò)
   ============================================ */
.meta-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    margin-top: 3px;
}

.priority-toggle {
    display: inline-flex;
    gap: 3px;
    background: rgba(15, 23, 42, 0.85);
    padding: 2px;
    border-radius: 5px;
    border: 1px solid rgba(55, 65, 81, 0.9);
}

.priority-btn {
    width: 18px;
    height: 18px;
    border-radius: 5px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    opacity: 0.25;
}

.priority-btn:hover {
    transform: scale(1.1);
    opacity: 0.55;
}

.priority-btn.active {
    opacity: 1;
    border-color: rgba(229, 231, 235, 0.4);
    box-shadow: 0 0 10px rgba(15, 23, 42, 0.6);
}

.priority-btn.low {
    background: linear-gradient(135deg, #064e3b, #047857);
}

.priority-btn.low.active {
    background: linear-gradient(135deg, #047857, #059669);
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
}

.priority-btn.medium {
    background: linear-gradient(135deg, #78350f, #b45309);
}

.priority-btn.medium.active {
    background: linear-gradient(135deg, #b45309, #ea580c);
    box-shadow: 0 0 10px rgba(245, 158, 11, 0.4);
}

.priority-btn.high {
    background: linear-gradient(135deg, #7f1d1d, #b91c1c);
}

.priority-btn.high.active {
    background: linear-gradient(135deg, #b91c1c, #ef4444);
    box-shadow: 0 0 10px rgba(248, 113, 113, 0.4);
}

.date-input {
    font-size: 13px;
    background: rgba(15, 23, 42, 0.7);
    border: 1px solid rgba(55, 65, 81, 0.9);
    border-radius: 6px;
    padding: 2px 8px;
    color: #9ca3af;
    font-family: inherit;
    transition: all 0.25s ease;
}

.date-input:focus {
    outline: none;
    border-color: rgba(129, 140, 248, 0.8);
    background: rgba(17, 24, 39, 0.9);
}

.tags {
    font-size: 13px;
    color: #9ca3af;
    padding: 2px 4px;
    border-radius: 5px;
    min-width: 50px;
    font-weight: 300;
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-10: –ü–û–î–ó–ê–î–ê–ß–ò
   ============================================ */
.subtasks {
    margin-top: 4px;
    padding-top: 4px;
    border-top: 1px solid rgba(148, 163, 184, 0.3);
}

.subtask-row {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: #e5e7eb;
    margin-bottom: 3px;
}

.subtask-row input[type="checkbox"] {
    appearance: none;
    width: 18px;
    height: 18px;
    border: 2px solid #6366f1;
    border-radius: 5px;
    background: transparent;
    cursor: pointer;
    flex-shrink: 0;
    position: relative;
    transition: all 0.25s ease;
    box-shadow: 0 0 8px rgba(129, 140, 248, 0.5);
}

.subtask-row input[type="checkbox"]:hover {
    border-color: #a5b4fc;
    box-shadow: 0 0 12px rgba(129, 140, 248, 0.8);
}

.subtask-row input[type="checkbox"]:checked {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    border-color: #a5b4fc;
    box-shadow: 0 0 16px rgba(129, 140, 248, 0.9);
}

.subtask-row input[type="checkbox"]:checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 13px;
    font-weight: 500;
}

.subtask-text {
    flex: 1;
    padding: 2px 4px;
    border-radius: 5px;
}

.subtask-row.completed .subtask-text {
    text-decoration: line-through;
    color: #6b7280;
}

.subtask-delete {
    border: none;
    background: transparent;
    color: #6b7280;
    font-size: 15px;
    cursor: pointer;
    padding: 0;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 3px;
    transition: all 0.25s ease;
    flex-shrink: 0;
}

.subtask-delete:hover {
    background: rgba(127, 29, 29, 0.5);
    color: #fecaca;
}

.subtask-mail-locked .subtask-delete {
    display: none !important;
}

.progress-bar-container {
    margin-top: 6px;
    margin-bottom: 4px;
    background: rgba(15, 23, 42, 0.9);
    border-radius: 999px;
    height: 7px;
    overflow: hidden;
    position: relative;
    border: 1px solid rgba(55, 65, 81, 0.9);
}

.progress-bar-fill {
    height: 100%;
    border-radius: 999px;
    background: linear-gradient(90deg, #6366f1, #a5b4fc);
    transition: width 0.45s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 12px rgba(129, 140, 248, 0.6);
}

.progress-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shimmer 2.4s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.subtasks-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 3px;
}

.progress {
    font-size: 12px;
    color: #9ca3af;
}

.mini-btn {
    border: none;
    background: transparent;
    color: #a5b4fc;
    font-size: 13px;
    cursor: pointer;
    padding: 0;
    transition: all 0.25s ease;
    font-family: inherit;
    font-weight: 400;
}

.mini-btn:hover {
    color: #e5e7eb;
    text-shadow: 0 0 8px rgba(129, 140, 248, 0.7);
}

.add-subtask-btn {
    border: none;
    background: rgba(99, 102, 241, 0.15);
    color: #a5b4fc;
    font-size: 14px;
    cursor: pointer;
    padding: 4px 10px;
    border-radius: 5px;
    transition: all 0.25s ease;
    font-family: inherit;
    font-weight: 400;
}

.add-subtask-btn:hover {
    background: rgba(99, 102, 241, 0.3);
    color: #e5e7eb;
    text-shadow: 0 0 8px rgba(129, 140, 248, 0.7);
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-11: –ö–ù–û–ü–ö–ê "–í –†–ê–ë–û–¢–£"
   ============================================ */
.move-to-work-btn {
    font-size: 13px;
    border-radius: 6px;
    padding: 3px 8px;
    background: radial-gradient(circle at 0% 0%, rgba(129, 140, 248, 0.4), transparent 50%), linear-gradient(135deg, #1e293b, #1d4ed8);
    color: #e5e7eb;
    border: 1px solid rgba(55, 65, 81, 0.9);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-weight: 500;
    transition: all 0.25s ease;
    font-family: inherit;
    box-shadow: 0 3px 10px rgba(15, 23, 42, 0.8);
}

.move-to-work-btn:hover {
    background: radial-gradient(circle at 0% 0%, rgba(129, 140, 248, 0.4), transparent 50%), linear-gradient(135deg, #111827, #1e40af);
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-12: –§–£–¢–ï–† –ö–ê–†–¢–û–ß–ö–ò
   ============================================ */
.card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 3px;
}

.archive-badge {
    font-size: 12px;
    color: #9ca3af;
}

.age-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 999px;
    font-weight: 400;
}

.age-fresh {
    background: rgba(5, 150, 105, 0.2);
    color: #6ee7b7;
    border: 1px solid rgba(5, 150, 105, 0.4);
}

.age-normal {
    background: rgba(217, 119, 6, 0.2);
    color: #fbbf24;
    border: 1px solid rgba(217, 119, 6, 0.4);
}

.age-old {
    background: rgba(220, 38, 38, 0.2);
    color: #fecaca;
    border: 1px solid rgba(220, 38, 38, 0.4);
}

.delete-task-btn {
    font-size: 13px;
    padding: 2px 6px;
    background: rgba(30, 27, 75, 0.9);
    border: 1px solid rgba(75, 85, 99, 0.9);
    color: #9ca3af;
}

.delete-task-btn:hover {
    background: rgba(24, 24, 27, 0.95);
    border-color: rgba(148, 163, 184, 0.9);
    color: #e5e7eb;
}

.archive-delete-btn {
    border: none;
    background: transparent;
    color: #6b7280;
    font-size: 18px;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.25s ease;
    line-height: 1;
}

.archive-delete-btn:hover {
    background: rgba(127, 29, 29, 0.6);
    color: #fecaca;
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-13: –û–í–ï–†–õ–ï–ô –ê–†–•–ò–í–ê
   ============================================ */
.archive-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 12, 25, 0.9);
    backdrop-filter: blur(10px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 30;
}

.archive-overlay.open {
    display: flex;
}

.archive-panel {
    background: rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(18px);
    border-radius: 18px;
    border: 1px solid rgba(129, 140, 248, 0.5);
    width: min(1200px, 96vw);
    max-height: min(80vh, 800px);
    display: flex;
    flex-direction: column;
    box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
}

.archive-header {
    padding: 15px 21px;
    border-bottom: 1px solid rgba(75, 85, 99, 0.9);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.archive-body {
    padding: 15px 21px 18px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 9px;
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-14: –î–ò–ê–õ–û–ì "–í–°–ï –ü–û–î–ó–ê–î–ê–ß–ò –í–´–ü–û–õ–ù–ï–ù–´"
   ============================================ */
.all-done-modal {
    position: absolute;
    background: rgba(17, 24, 39, 0.98);
    backdrop-filter: blur(18px);
    border-radius: 15px;
    border: 1px solid rgba(129, 140, 248, 0.5);
    padding: 21px 24px 18px;
    box-shadow: 0 30px 70px rgba(15, 23, 42, 0.95);
    z-index: 41;
    max-width: 320px;
    width: 90%;
}

.all-done-modal .modal-title {
    font-size: 18px;
    margin-bottom: 12px;
    font-weight: 500;
    color: #e5e7eb;
}

.all-done-modal .modal-text {
    font-size: 15px;
    color: #9ca3af;
    margin-bottom: 18px;
}

.all-done-modal .modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-15: –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–û–ë–©–ï–ï)
   ============================================ */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 12, 25, 0.95);
    backdrop-filter: blur(10px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 40;
}

.modal-overlay.open {
    display: flex;
}

.modal {
    background: rgba(17, 24, 39, 0.98);
    backdrop-filter: blur(18px);
    border-radius: 15px;
    border: 1px solid rgba(129, 140, 248, 0.5);
    padding: 21px 24px 18px;
    max-width: 480px;
    width: 100%;
    box-shadow: 0 30px 70px rgba(15, 23, 42, 0.95);
}

.modal-title {
    font-size: 20px;
    margin-bottom: 9px;
    font-weight: 500;
    color: #e5e7eb;
}

.modal-text {
    font-size: 16px;
    color: #9ca3af;
    margin-bottom: 15px;
}

.modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-16: –¢–û–°–¢–´ (–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø)
   ============================================ */
.toast-container {
    position: fixed;
    bottom: 18px;
    right: 18px;
    display: flex;
    flex-direction: column;
    gap: 9px;
    z-index: 50;
}

.toast {
    background: linear-gradient(135deg, #4f46e5, #6366f1);
    color: #e5e7eb;
    padding: 9px 15px;
    border-radius: 10px;
    font-size: 15px;
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.9);
    display: flex;
    align-items: center;
    gap: 9px;
    animation: fade-slide 0.45s ease-out;
    border: 1px solid rgba(129, 140, 248, 0.6);
}

@keyframes fade-slide {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-17: –°–õ–û–ô –ü–†–ê–ó–î–ù–û–í–ê–ù–ò–Ø (–ê–ù–ò–ú–ê–¶–ò–ò)
   ============================================ */
.celebration-layer {
    pointer-events: none;
    position: fixed;
    inset: 0;
    overflow: hidden;
    z-index: 35;
}

.sparkle, .confetti, .firework, .star, .bubble, .heart, .lightning, .ring {
    position: absolute;
    pointer-events: none;
}

.sparkle {
    width: 12px;
    height: 12px;
    background: #a5b4fc;
    border-radius: 50%;
    box-shadow: 0 0 20px #a5b4fc, 0 0 40px #6366f1;
    animation: sparkle-pop 900ms ease-out forwards;
}

@keyframes sparkle-pop {
    0% { transform: scale(0.3); opacity: 0; }
    40% { transform: scale(1.5); opacity: 1; }
    100% { transform: scale(0.1); opacity: 0; }
}

.star {
    width: 16px;
    height: 16px;
    background: linear-gradient(45deg, #a5b4fc, #6366f1);
    clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
    animation: star-twinkle 1100ms ease-out forwards;
}

@keyframes star-twinkle {
    0% { transform: scale(0.2) rotate(0deg); opacity: 0; }
    50% { transform: scale(1.4) rotate(180deg); opacity: 1; }
    100% { transform: scale(0.2) rotate(360deg); opacity: 0; }
}

.confetti {
    width: 10px;
    height: 16px;
    border-radius: 2px;
    animation: confetti-fall 1800ms ease-out forwards;
}

@keyframes confetti-fall {
    0% { opacity: 0; transform: translateY(-15px) rotate(0deg); }
    20% { opacity: 1; }
    100% { opacity: 0; transform: translateY(60px) rotate(280deg); }
}

.firework {
    width: 8px;
    height: 24px;
    border-radius: 4px;
    animation: firework-burst 1800ms ease-out forwards;
    transform-origin: bottom center;
}

@keyframes firework-burst {
    0% { opacity: 0; transform: translateY(0) scaleY(0.2); }
    30% { opacity: 1; transform: translateY(-35px) scaleY(1.2); }
    100% { opacity: 0; transform: translateY(-70px) scaleY(0.1); }
}

.bubble {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 3px solid;
    animation: bubble-rise 2100ms ease-out forwards;
}

@keyframes bubble-rise {
    0% { opacity: 0; transform: translateY(0) scale(0.5); }
    30% { opacity: 0.8; }
    100% { opacity: 0; transform: translateY(-80px) scale(1.2); }
}

.heart {
    width: 14px;
    height: 14px;
    background: #ec4899;
    transform: rotate(-45deg);
    animation: heart-float 1500ms ease-out forwards;
}

.heart::before,
.heart::after {
    content: '';
    width: 14px;
    height: 14px;
    background: #ec4899;
    border-radius: 50%;
    position: absolute;
}

.heart::before {
    top: -7px;
    left: 0;
}

.heart::after {
    left: 7px;
    top: 0;
}

@keyframes heart-float {
    0% { opacity: 0; transform: translateY(0) rotate(-45deg) scale(0.3); }
    40% { opacity: 1; }
    100% { opacity: 0; transform: translateY(-60px) rotate(-45deg) scale(0.8); }
}

.lightning {
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 16px solid #fbbf24;
    animation: lightning-strike 1000ms ease-out forwards;
}

@keyframes lightning-strike {
    0% { opacity: 0; transform: translateY(-20px) scale(0.5); }
    30% { opacity: 1; transform: translateY(0) scale(1.2); }
    100% { opacity: 0; transform: translateY(40px) scale(0.3); }
}

.ring {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 3px solid;
    animation: ring-expand 1300ms ease-out forwards;
}

@keyframes ring-expand {
    0% { opacity: 0.8; transform: scale(0.3); }
    100% { opacity: 0; transform: scale(2.5); }
}

/* ============================================
   –ë–õ–û–ö –°–¢–ò–õ–ò-18: –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨
   ============================================ */
@media (max-width: 1200px) {
    header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .column {
        width: 300px;
    }

    .done-box {
        width: 300px;
    }
}
    </style>
</head>
<body>
    <header>
        <h1 id="appTitle"></h1>
<div class="buttons">
    <button class="secondary undo-btn" id="undoDeleteBtn" disabled>–í–µ—Ä–Ω—É—Ç—å –∑–∞–¥–∞—á—É</button>
    <button class="secondary" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
    <button class="secondary" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
    <button id="archiveToggle">–ê—Ä—Ö–∏–≤</button>
</div>

    </header>

    <main>
        <div class="board" id="board"></div>
    </main>

    <div class="archive-overlay" id="archiveOverlay">
        <div class="archive-panel">
            <div class="archive-header">
                <div style="font-size:20px;font-weight:500">–ê—Ä—Ö–∏–≤</div>
                <div style="font-size:15px;color:#9ca3af" id="archiveCount">0</div>
            </div>
            <div class="archive-body" id="archiveList"></div>
            <div style="padding:15px 21px;border-top:1px solid rgba(75,85,99,0.9);display:flex;justify-content:flex-end;gap:12px">
                <button class="secondary" id="closeArchiveBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="secondary danger" id="clearArchiveBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-text" id="modalText"></div>
            <div class="modal-buttons">
                <button class="secondary" id="modalNoButton">–ù–µ—Ç</button>
                <button id="modalYesButton">–î–∞</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    <div class="celebration-layer" id="celebrationLayer"></div>

    <input type="file" id="fileInput" accept="application/json" style="display:none">

    <script>

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-2: –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
   ============================================ */
const STORAGE_KEY = 'kanbansingularitystylev10';
const LAST_EXPORT_KEY = 'kanbansingularitylastexport';

document.getElementById('appTitle').textContent = APPCONFIG.title;
document.title = APPCONFIG.title;

const initialData = {
    columns: APPCONFIG.columns.map(c => ({ ...c })),
    tasks: [],
    archive: []
};

function loadState() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(initialData);
        
        const parsed = JSON.parse(raw);
        if (!parsed.columns || !parsed.tasks || !parsed.archive) throw new Error('bad');
        
        parsed.columns = APPCONFIG.columns.map(c => ({ ...c }));
        if (!parsed.tasksOrder) parsed.tasksOrder = {};
        
        return parsed;
    } catch (e) {
        return structuredClone(initialData);
    }
}

let state = loadState();

// –ú–∏–≥—Ä–∞—Ü–∏—è: –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –≤ —Å—Ç–∞—Ä—ã—Ö –ø–æ–¥–∑–∞–¥–∞—á–∞—Ö
state.tasks.forEach(task => {
    if (task.subtasks) {
        task.subtasks.forEach(sub => {
            if (sub.isLocked && sub.text.includes('üïäÔ∏è')) {
                sub.text = '‚úâÔ∏èüöÄ –ü–∏—Å—å–º–æ –æ —Å–¥–µ–ª–∞–Ω–Ω–æ–º';
            }
        });
    }
});
state.archive.forEach(task => {
    if (task.subtasks) {
        task.subtasks.forEach(sub => {
            if (sub.isLocked && sub.text.includes('üïäÔ∏è')) {
                sub.text = '‚úâÔ∏èüöÄ –ü–∏—Å—å–º–æ –æ —Å–¥–µ–ª–∞–Ω–Ω–æ–º';
            }
        });
    }
});

// –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á –∏–∑ –∞—Ä—Ö–∏–≤–∞
function cleanOldArchive() {
    const now = Date.now();
    const maxAge = APPCONFIG.archiveAutoDeleteDays * 24 * 60 * 60 * 1000;
    const before = state.archive.length;
    state.archive = state.archive.filter(t => (now - (t.archivedAt || 0)) < maxAge);
    if (state.archive.length < before) {
        saveState();
    }
}
cleanOldArchive();

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å—É—Ç–∫–∏
let todayStats = {
    date: new Date().toDateString(),
    tasksCompleted: 0,
    subtasksCompleted: 0
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω—É–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –ø–æ–ª–Ω–æ—á—å
function checkStatsReset() {
    const now = new Date();
    const currentDate = now.toDateString();
    if (todayStats.date !== currentDate) {
        todayStats = {
            date: currentDate,
            tasksCompleted: 0,
            subtasksCompleted: 0
        };
    }
}
checkStatsReset();

function incrementTaskStats() {
    checkStatsReset();
    todayStats.tasksCompleted++;
}

function incrementSubtaskStats() {
    checkStatsReset();
    todayStats.subtasksCompleted++;
}


/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-3: DOM –≠–õ–ï–ú–ï–ù–¢–´
   ============================================ */
const boardEl = document.getElementById('board');
const archiveOverlay = document.getElementById('archiveOverlay');
const archiveListEl = document.getElementById('archiveList');
const archiveCountEl = document.getElementById('archiveCount');
const modalOverlay = document.getElementById('modalOverlay');
const modalTitleEl = document.getElementById('modalTitle');
const modalTextEl = document.getElementById('modalText');
const modalYesBtn = document.getElementById('modalYesButton');
const modalNoBtn = document.getElementById('modalNoButton');
const toastContainer = document.getElementById('toastContainer');
const celebrationLayer = document.getElementById('celebrationLayer');
const fileInput = document.getElementById('fileInput');

let dragTaskId = null;
let dragOverColumnId = null;
let dragPlaceholder = null;
let modalResolve = null;
let pendingFocusSubtask = null;
let pendingFocusTaskId = null;
let lastDeletedTask = null;

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-4: –ë–ê–ó–û–í–´–ï –§–£–ù–ö–¶–ò–ò
   ============================================ */
function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    renderBoard();
    renderArchive();
}

function showToast(text) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = text;
    toastContainer.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(12px)';
        setTimeout(() => toast.remove(), 450);
    }, 2300);
}

function randomBetween(min, max) {
    return Math.random() * (max - min) + min;
}

function randomEffect() {
    return Math.floor(Math.random() * 6);
}

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-5: –§–£–ù–ö–¶–ò–ò –ü–†–ê–ó–î–ù–û–í–ê–ù–ò–Ø (–ê–ù–ò–ú–ê–¶–ò–ò)
   ============================================ */
function spawnSparkles(x, y) {
    for (let i = 0; i < 8; i++) {
        const s = document.createElement('div');
        s.className = 'sparkle';
        s.style.left = `${x + randomBetween(-12, 12)}px`;
        s.style.top = `${y + randomBetween(-12, 12)}px`;
        celebrationLayer.appendChild(s);
        setTimeout(() => s.remove(), 1000);
    }
}

function spawnStars(x, y) {
    for (let i = 0; i < 6; i++) {
        const s = document.createElement('div');
        s.className = 'star';
        s.style.left = `${x + randomBetween(-20, 20)}px`;
        s.style.top = `${y + randomBetween(-20, 20)}px`;
        celebrationLayer.appendChild(s);
        setTimeout(() => s.remove(), 1200);
    }
}

function spawnConfetti(x, y) {
    const colors = ['#a5b4fc', '#6366f1', '#4f46e5', '#4338ca', '#ec4899'];
    for (let i = 0; i < 24; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = `${x + randomBetween(-60, 60)}px`;
        c.style.top = `${y + randomBetween(-20, 20)}px`;
        c.style.background = colors[Math.floor(Math.random() * colors.length)];
        c.style.transform = `rotate(${randomBetween(-60, 60)}deg)`;
        celebrationLayer.appendChild(c);
        setTimeout(() => c.remove(), 1850);
    }
}

function spawnFireworks(x, y) {
    const colors = ['#a5b4fc', '#6366f1', '#4f46e5', '#fbbf24'];
    for (let i = 0; i < 24; i++) {
        const f = document.createElement('div');
        f.className = 'firework';
        f.style.left = `${x}px`;
        f.style.top = `${y - 30}px`;
        f.style.background = colors[Math.floor(Math.random() * colors.length)];
        f.style.transform = `rotate(${i * 15}deg)`;
        celebrationLayer.appendChild(f);
        setTimeout(() => f.remove(), 1900);
    }
}

function spawnBubbles(x, y) {
    const colors = ['#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'];
    for (let i = 0; i < 8; i++) {
        const b = document.createElement('div');
        b.className = 'bubble';
        b.style.left = `${x + randomBetween(-40, 40)}px`;
        b.style.top = `${y + randomBetween(-10, 10)}px`;
        b.style.borderColor = colors[Math.floor(Math.random() * colors.length)];
        celebrationLayer.appendChild(b);
        setTimeout(() => b.remove(), 2200);
    }
}

function spawnHearts(x, y) {
    for (let i = 0; i < 6; i++) {
        const h = document.createElement('div');
        h.className = 'heart';
        h.style.left = `${x + randomBetween(-30, 30)}px`;
        h.style.top = `${y + randomBetween(-10, 10)}px`;
        celebrationLayer.appendChild(h);
        setTimeout(() => h.remove(), 1500);
    }
}

function spawnLightning(x, y) {
    for (let i = 0; i < 10; i++) {
        const l = document.createElement('div');
        l.className = 'lightning';
        l.style.left = `${x + randomBetween(-40, 40)}px`;
        l.style.top = `${y + randomBetween(-20, 20)}px`;
        celebrationLayer.appendChild(l);
        setTimeout(() => l.remove(), 1000);
    }
}

function spawnRings(x, y) {
    const colors = ['#6366f1', '#818cf8', '#a5b4fc', '#fbbf24'];
    for (let i = 0; i < 4; i++) {
        const r = document.createElement('div');
        r.className = 'ring';
        r.style.left = `${x - 15}px`;
        r.style.top = `${y - 15}px`;
        r.style.borderColor = colors[i % colors.length];
        r.style.animationDelay = `${i * 0.15}s`;
        celebrationLayer.appendChild(r);
        setTimeout(() => r.remove(), 1350);
    }
}

function playRandomCelebration(x, y) {
    const effect = randomEffect();
    switch (effect) {
        case 0: spawnConfetti(x, y); spawnStars(x, y); break;
        case 1: spawnSparkles(x, y); spawnBubbles(x, y); break;
        case 2: spawnHearts(x, y); spawnSparkles(x, y); break;
        case 3: spawnLightning(x, y); spawnRings(x, y); break;
        case 4: spawnRings(x, y); spawnConfetti(x, y); break;
        case 5: spawnStars(x, y); spawnHearts(x, y); break;
    }
}

// –¢—Ä–æ–π–Ω–æ–µ –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–ª–æ–∫–∞ "–°–¥–µ–ª–∞–Ω–æ"
function playTripleCelebration(x, y) {
    playRandomCelebration(x, y);
    setTimeout(() => playRandomCelebration(x + randomBetween(-30, 30), y + randomBetween(-20, 20)), 400);
    setTimeout(() => playRandomCelebration(x + randomBetween(-30, 30), y + randomBetween(-20, 20)), 800);
}

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-6: –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê
   ============================================ */
function openConfirm(title, text) {
    modalTitleEl.textContent = title;
    modalTextEl.textContent = text;
    modalOverlay.classList.add('open');
    
    return new Promise(resolve => {
        modalResolve = resolve;
        
        const yesHandler = () => {
            modalOverlay.classList.remove('open');
            modalYesBtn.removeEventListener('click', yesHandler);
            modalNoBtn.removeEventListener('click', noHandler);
            resolve(true);
        };
        
        const noHandler = () => {
            modalOverlay.classList.remove('open');
            modalYesBtn.removeEventListener('click', yesHandler);
            modalNoBtn.removeEventListener('click', noHandler);
            resolve(false);
        };
        
        modalYesBtn.addEventListener('click', yesHandler);
        modalNoBtn.addEventListener('click', noHandler);
    });
}

function showAllDoneDialog(taskId, taskRect, totalSubtasks) {
    const modal = document.createElement('div');
    modal.className = 'all-done-modal';
    modal.innerHTML = `
        <div class="modal-title">–í—Å–µ –ø–æ–¥–∑–∞–¥–∞—á–∏ (${totalSubtasks}) –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!</div>
        <div class="modal-text">–í—Å—ë, –≤ –∞—Ä—Ö–∏–≤?</div>
        <div class="modal-buttons">
            <button class="secondary">–û—Ç–º–µ–Ω–∞</button>
            <button>–û–∫</button>
        </div>
    `;
    
    modal.style.left = `${Math.max(10, taskRect.left + taskRect.width/2 - 160)}px`;
    modal.style.top = `${Math.max(10, taskRect.top - 150)}px`;
    
    document.body.appendChild(modal);
    
    const yesBtn = modal.querySelector('button:last-child');
    const noBtn = modal.querySelector('button:first-of-type');
    
    return new Promise(resolve => {
        yesBtn.onclick = () => {
            document.body.removeChild(modal);
            resolve(true);
        };
        noBtn.onclick = () => {
            document.body.removeChild(modal);
            resolve(false);
        };
    }).then(yes => {
        if (yes) {
            archiveTask(taskId, false);
        }
    });
}

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-7: –§–£–ù–ö–¶–ò–ò –ó–ê–î–ê–ß
   ============================================ */
function updateColumnCounts() {
    const counts = {};
    for (const col of state.columns) counts[col.id] = 0;
    for (const t of state.tasks) {
        if (!t.archivedAt) counts[t.columnId] = (counts[t.columnId] || 0) + 1;
    }
    
    document.querySelectorAll('.column').forEach(colEl => {
        const colId = colEl.dataset.id;
        const countEl = colEl.querySelector('.column-count');
        if (countEl) countEl.textContent = counts[colId] || 0;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –¥–ª—è done-box
    const doneBox = document.querySelector('.done-box');
    if (doneBox) {
        const countEl = doneBox.querySelector('.column-count');
        if (countEl) countEl.textContent = counts['done'] || 0;
    }
}

function archiveTask(taskId, withDelay = false) {
    const idx = state.tasks.findIndex(t => t.id === taskId);
    if (idx === -1) return;

    if (withDelay) {
        const cardEl = document.querySelector(`[data-id="${taskId}"]`);
        if (cardEl) {
            setTimeout(() => {
                cardEl.classList.add('archiving');
            });
            const rect = cardEl.getBoundingClientRect();
            spawnFireworks(rect.left + rect.width/2, rect.top + rect.height/2 - 20);
            spawnBubbles(rect.left + rect.width/2, rect.top + rect.height/2);
        }
        
        setTimeout(() => {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                const idx2 = state.tasks.indexOf(task);
                if (idx2 !== -1) {
                    const t = state.tasks.splice(idx2, 1)[0];
                    t.archivedAt = Date.now();
                    state.archive.unshift(t);
					incrementTaskStats();
                    saveState();
                    showToast('–í –∞—Ä—Ö–∏–≤!');
                }
            }
        }, 900);
    } else {
        const task = state.tasks.splice(idx, 1)[0];
        task.archivedAt = Date.now();
        state.archive.unshift(task);
		incrementTaskStats();
        saveState();
        showToast('–í –∞—Ä—Ö–∏–≤!');
    }
}

function deleteTask(taskId) {
    const idx = state.tasks.findIndex(t => t.id === taskId);
    if (idx !== -1) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        lastDeletedTask = JSON.parse(JSON.stringify(state.tasks[idx]));
        state.tasks.splice(idx, 1);
        saveState();
        showToast('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞');
        updateUndoButton();
    }
}

function undoDeleteTask() {
    if (!lastDeletedTask) return;
    state.tasks.unshift(lastDeletedTask);
    ensureTasksOrderForColumn(lastDeletedTask.columnId);
    state.tasksOrder[lastDeletedTask.columnId].unshift(lastDeletedTask.id);
    const restoredTitle = lastDeletedTask.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    lastDeletedTask = null;
    saveState();
    showToast(`–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ: ${restoredTitle}`);
    updateUndoButton();
}

function updateUndoButton() {
    const btn = document.getElementById('undoDeleteBtn');
    if (btn) {
        btn.disabled = !lastDeletedTask;
    }
}

function deleteArchivedTask(taskId) {
    const idx = state.archive.findIndex(t => t.id === taskId);
    if (idx !== -1) {
        state.archive.splice(idx, 1);
        saveState();
        showToast('–ò–∑ –∞—Ä—Ö–∏–≤–∞ —É–¥–∞–ª–µ–Ω–æ');
    }
}

function restoreTask(taskId) {
    const idx = state.archive.findIndex(t => t.id === taskId);
    if (idx === -1) return;
    
    const task = state.archive.splice(idx, 1)[0];
    task.archivedAt = null;
    task.columnId = 'napadalo';
    state.tasks.unshift(task);
    saveState();
    showToast('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
}

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-8: –ü–û–†–Ø–î–û–ö –ó–ê–î–ê–ß –í –ö–û–õ–û–ù–ö–ê–•
   ============================================ */
function ensureTasksOrderForColumn(columnId) {
    if (!state.tasksOrder) state.tasksOrder = {};
    if (!state.tasksOrder[columnId]) {
        const ids = state.tasks
            .filter(t => t.columnId === columnId && !t.archivedAt)
            .sort((a, b) => a.createdAt - b.createdAt)
            .map(t => t.id);
        state.tasksOrder[columnId] = ids;
    }
}

function reorderInColumn(columnId, taskId, beforeTaskId) {
    ensureTasksOrderForColumn(columnId);
    const list = state.tasksOrder[columnId].filter(id => {
        const t = state.tasks.find(tt => tt.id === id);
        return t && !t.archivedAt && t.columnId === columnId;
    });

    if (!list.includes(taskId)) {
        list.push(taskId);
    }

    const idx = list.indexOf(taskId);
    if (idx !== -1) list.splice(idx, 1);

    if (beforeTaskId) {
        const beforeIdx = list.indexOf(beforeTaskId);
        if (beforeIdx !== -1) {
            list.splice(beforeIdx, 0, taskId);
        } else {
            list.push(taskId);
        }
    } else {
        list.push(taskId);
    }

    state.tasksOrder[columnId] = list;
}

function handleDropTask(taskId, newColumnId, beforeTaskId, evt) {
    const task = state.tasks.find(t => t.id === taskId);
    if (!task) return;

    const rect = boardEl.getBoundingClientRect();
    const x = evt.clientX;
    const y = evt.clientY;

    task.columnId = newColumnId;
    reorderInColumn(newColumnId, taskId, beforeTaskId);
    saveState();
    
    // –¢—Ä–æ–π–Ω–æ–µ –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è "–°–¥–µ–ª–∞–Ω–æ"
    if (newColumnId === 'done') {
        playTripleCelebration(x, y);
        archiveTask(taskId, true);
    } else {
        playRandomCelebration(x, y);
    }
}

function getTaskAge(createdAt) {
    const now = Date.now();
    const ageMs = now - createdAt;
    const ageDays = Math.floor(ageMs / 1000 / 60 / 60 / 24);

    if (ageDays < 3) return { class: 'age-fresh', text: '—Å–≤–µ–∂–∞—è' };
    else if (ageDays < 7) return { class: 'age-normal', text: `${ageDays}–¥` };
    else return { class: 'age-old', text: `${ageDays}–¥` };
}

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-9: –†–ï–ù–î–ï–† –ü–û–î–ó–ê–î–ê–ß
   ============================================ */
function renderSubtasks(task, container, cardEl) {
    container.innerHTML = '';

    if (!task.subtasks) task.subtasks = [];

    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é –ø–æ–¥–∑–∞–¥–∞—á—É "–ü–∏—Å—å–º–æ –æ —Å–¥–µ–ª–∞–Ω–Ω–æ–º" –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    const mailSubtaskId = `mail_${task.id}`;
    if (!task.subtasks.some(s => s.id === mailSubtaskId)) {
        task.subtasks.push({
            id: mailSubtaskId,
            text: '‚úâÔ∏èüí´ –ü–∏—Å—å–º–æ –æ —Å–¥–µ–ª–∞–Ω–Ω–æ–º',
            done: false,
            isLocked: true
        });
    }

    const doneCount = task.subtasks.filter(s => s.done).length;
    const progress = task.subtasks.length > 0 ? (doneCount / task.subtasks.length) * 100 : 0;

    const progressContainer = document.createElement('div');
    progressContainer.className = 'progress-bar-container';
    const progressFill = document.createElement('div');
    progressFill.className = 'progress-bar-fill';
    progressFill.style.width = `${progress}%`;
    progressContainer.appendChild(progressFill);
    container.appendChild(progressContainer);

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–¥–∑–∞–¥–∞—á–∏: –æ–±—ã—á–Ω—ã–µ —Å–≤–µ—Ä—Ö—É, –ø–∏—Å—å–º–æ —Å–Ω–∏–∑—É
    const regularSubtasks = task.subtasks.filter(s => !s.isLocked);
    const lockedSubtask = task.subtasks.find(s => s.isLocked);
    const sortedSubtasks = [...regularSubtasks, ...(lockedSubtask ? [lockedSubtask] : [])];

    sortedSubtasks.forEach((sub) => {
        const row = document.createElement('div');
        row.className = `subtask-row ${sub.done ? 'completed' : ''}`;
        if (sub.isLocked) row.classList.add('subtask-mail-locked');

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = sub.done;
        cb.addEventListener('change', (e) => {
            sub.done = e.target.checked;
			if (sub.done) incrementSubtaskStats();
            const rect = e.target.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            spawnSparkles(x, y);
            spawnStars(x, y);

            row.classList.toggle('completed', sub.done);

            const allDone = task.subtasks.length > 0 && task.subtasks.every(s => s.done);
            if (allDone) {
                const cardRect = cardEl.getBoundingClientRect();
                spawnFireworks(cardRect.left + cardRect.width / 2, cardRect.top + cardRect.height / 2);
                spawnBubbles(cardRect.left + cardRect.width / 2, cardRect.top + cardRect.height / 2);
                setTimeout(() => {
                    showAllDoneDialog(task.id, cardRect, task.subtasks.length);
                }, 1100);
            } else {
                saveState();
            }
        });

        const span = document.createElement('span');
        span.className = 'subtask-text';
        span.textContent = sub.text;
        span.contentEditable = true;
        span.dataset.subtaskId = sub.id;
        span.dataset.taskId = task.id;
        span.setAttribute('data-placeholder', '–ü–æ–¥–∑–∞–¥–∞—á–∞...');
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç–æ–π –ø–æ–¥–∑–∞–¥–∞—á–∏ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
        span.addEventListener('blur', () => {
            setTimeout(() => {
                const newText = span.textContent.trim();
                const stillExists = task.subtasks.find(s => s.id === sub.id);
                if (!stillExists) return;
                
                if (newText === '' && !sub.isLocked) {
                    const subIdx = task.subtasks.findIndex(s => s.id === sub.id);
                    if (subIdx !== -1) {
                        task.subtasks.splice(subIdx, 1);
                        saveState();
                    }
                } else if (newText !== sub.text) {
                    sub.text = newText;
                    saveState();
                }
            }, 100);
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–¥–∑–∞–¥–∞—á–∏ –ø–æ Enter
        span.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–π –ø–æ–¥–∑–∞–¥–∞—á–∏
                sub.text = span.textContent.trim();
                
                const newSubId = 'sub_' + Math.random().toString(36).slice(2, 8);
                const currentIdx = task.subtasks.findIndex(s => s.id === sub.id);
                const insertIdx = sub.isLocked ? currentIdx : currentIdx + 1;
                
                task.subtasks.splice(insertIdx, 0, {
                    id: newSubId,
                    text: '',
                    done: false,
                    isLocked: false
                });
                
                pendingFocusSubtask = newSubId;
                pendingFocusTaskId = task.id;
                saveState();
            }
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'subtask-delete';
        deleteBtn.textContent = '√ó';
        deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
        if (!sub.isLocked) {
            deleteBtn.addEventListener('click', () => {
                const subIdx = task.subtasks.findIndex(s => s.id === sub.id);
                if (subIdx !== -1) {
                    task.subtasks.splice(subIdx, 1);
                    saveState();
                }
            });
        }

        row.appendChild(cb);
        row.appendChild(span);
        if (!sub.isLocked) row.appendChild(deleteBtn);
        container.appendChild(row);

        // –§–æ–∫—É—Å –Ω–∞ –Ω–æ–≤—É—é –ø–æ–¥–∑–∞–¥–∞—á—É
        if (pendingFocusSubtask && pendingFocusTaskId === task.id && sub.id === pendingFocusSubtask) {
            const targetSpan = span;
            pendingFocusSubtask = null;
            pendingFocusTaskId = null;
            setTimeout(() => {
                targetSpan.focus();
                // –°—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü
                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(targetSpan);
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
            }, 30);
        }
    });

    const footer = document.createElement('div');
    footer.className = 'subtasks-footer';
    const progressText = document.createElement('div');
    progressText.className = 'progress';
    progressText.textContent = task.subtasks.length ? `${doneCount}/${task.subtasks.length}` : '0/0';
    const addBtn = document.createElement('button');
    addBtn.className = 'add-subtask-btn';
    addBtn.textContent = '+–ü–æ–¥–∑–∞–¥–∞—á–∞';
    addBtn.addEventListener('click', () => {
        const id = 'sub_' + Math.random().toString(36).slice(2, 8);
        const mailIdx = task.subtasks.findIndex(s => s.isLocked);
        if (mailIdx !== -1) {
            task.subtasks.splice(mailIdx, 0, { id, text: '', done: false, isLocked: false });
        } else {
            task.subtasks.push({ id, text: '', done: false, isLocked: false });
        }
        pendingFocusSubtask = id;
        pendingFocusTaskId = task.id;
        saveState();
    });
    footer.appendChild(progressText);
    footer.appendChild(addBtn);
    container.appendChild(footer);
}

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-10: –†–ï–ù–î–ï–† –ö–ê–†–¢–û–ß–ö–ò
   ============================================ */
function renderCard(task) {
    const card = document.createElement('div');
    card.className = 'card';
    card.draggable = true;
    card.dataset.id = task.id;

    card.addEventListener('dragstart', (e) => {
        dragTaskId = task.id;
        dragOverColumnId = task.columnId;
        card.classList.add('dragging');
        dragPlaceholder = document.createElement('div');
        dragPlaceholder.className = 'card-placeholder';
        card.parentElement.insertBefore(dragPlaceholder, card.nextSibling);
        e.dataTransfer.effectAllowed = 'move';
    });

    card.addEventListener('dragend', () => {
        dragTaskId = null;
        dragOverColumnId = null;
        card.classList.remove('dragging');
        if (dragPlaceholder) {
            dragPlaceholder.remove();
            dragPlaceholder = null;
        }
    });

    const header = document.createElement('div');
    header.className = 'card-header';

    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = task.title;
    title.contentEditable = true;
    title.setAttribute('data-placeholder', '–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏...');
    title.addEventListener('blur', () => {
        task.title = title.textContent.trim();
        saveState();
    });
    title.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            title.blur();
        }
    });

    const quickBtnWrap = document.createElement('div');
    if (task.columnId === 'napadalo') {
        const btn = document.createElement('button');
        btn.className = 'move-to-work-btn';
        btn.textContent = '–í —Ä–∞–±–æ—Ç—É';
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            task.columnId = 'inprogress';
            reorderInColumn('inprogress', task.id, null);
            saveState();
            const rect = btn.getBoundingClientRect();
            playRandomCelebration(rect.left + rect.width / 2, rect.top + rect.height / 2);
            showToast('–í —Ä–∞–±–æ—Ç—É!');
        });
        quickBtnWrap.appendChild(btn);
    }
    header.appendChild(title);
    header.appendChild(quickBtnWrap);

    const description = document.createElement('div');
    description.className = 'description';
    description.textContent = task.description;
    description.contentEditable = true;
    description.setAttribute('data-placeholder', '–û–ø–∏—Å–∞–Ω–∏–µ...');
    description.addEventListener('blur', () => {
        task.description = description.textContent.trim();
        saveState();
    });

    const meta = document.createElement('div');
    meta.className = 'meta-row';

    const priorityToggle = document.createElement('div');
    priorityToggle.className = 'priority-toggle';
    const priorities = ['low', 'medium', 'high'];
    priorities.forEach(p => {
        const btn = document.createElement('button');
        btn.className = `priority-btn ${p}`;
        btn.title = p === 'low' ? '–ù–∏–∑–∫–∏–π' : p === 'medium' ? '–°—Ä–µ–¥–Ω–∏–π' : '–í—ã—Å–æ–∫–∏–π';
        if (task.priority === p || (!task.priority && p === 'low')) {
            btn.classList.add('active');
        }
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            task.priority = p;
            priorityToggle.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            saveState();
        });
        priorityToggle.appendChild(btn);
    });

    const rightMeta = document.createElement('div');
    rightMeta.style.display = 'flex';
    rightMeta.style.alignItems = 'center';
    rightMeta.style.gap = '6px';

    const dateInput = document.createElement('input');
    dateInput.type = 'date';
    dateInput.className = 'date-input';
    dateInput.value = task.dueDate;
    dateInput.addEventListener('change', () => {
        task.dueDate = dateInput.value;
        saveState();
    });

    const tags = document.createElement('div');
    tags.className = 'tags';
    tags.textContent = task.tags;
    tags.contentEditable = true;
    tags.setAttribute('data-placeholder', '–¢–µ–≥–∏...');
    tags.addEventListener('blur', () => {
        task.tags = tags.textContent.trim();
        saveState();
    });
    tags.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            tags.blur();
        }
    });

    rightMeta.appendChild(dateInput);
    rightMeta.appendChild(tags);

    meta.appendChild(priorityToggle);
    meta.appendChild(rightMeta);

    const subtasksWrap = document.createElement('div');
    subtasksWrap.className = 'subtasks';
    renderSubtasks(task, subtasksWrap, card);

    const footer = document.createElement('div');
    footer.className = 'card-footer';

    const age = getTaskAge(task.createdAt);
    const ageInd = document.createElement('div');
    ageInd.className = `age-indicator ${age.class}`;
    ageInd.textContent = age.text;

    const btnGroup = document.createElement('div');
    btnGroup.style.display = 'flex';
    btnGroup.style.gap = '6px';

    const moveBtn = document.createElement('button');
    moveBtn.className = 'mini-btn';
    moveBtn.textContent = '–í –∞—Ä—Ö–∏–≤';
    moveBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const rect = card.getBoundingClientRect();
        spawnFireworks(rect.left + rect.width / 2, rect.top + rect.height / 2);
        spawnBubbles(rect.left + rect.width / 2, rect.top + rect.height / 2);
        archiveTask(task.id, false);
    });

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'mini-btn delete-task-btn';
    deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
    deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteTask(task.id);
    });

    btnGroup.appendChild(moveBtn);
    btnGroup.appendChild(deleteBtn);

    footer.appendChild(ageInd);
    footer.appendChild(btnGroup);

    card.appendChild(header);
    card.appendChild(description);
    card.appendChild(meta);
    card.appendChild(subtasksWrap);
    card.appendChild(footer);

    return card;
}

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-11: –†–ï–ù–î–ï–† –î–û–°–ö–ò
   ============================================ */
function renderBoard() {
    boardEl.innerHTML = '';

    const sortedColumns = [...state.columns].sort((a, b) => a.order - b.order);
    
    sortedColumns.forEach(col => {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º "done" ‚Äî –æ–Ω —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
        if (col.id === 'done') return;
        
        // –î–ª—è "stuck" —Å–æ–∑–¥–∞—ë–º –æ–±—ë—Ä—Ç–∫—É —Å done-box —Å–≤–µ—Ä—Ö—É
        if (col.id === 'stuck') {
            const wrapper = document.createElement('div');
            wrapper.className = 'done-wrapper';
            
            // –ë–ª–æ–∫ "–°–¥–µ–ª–∞–Ω–æ" —Å–≤–µ—Ä—Ö—É
            const doneCol = state.columns.find(c => c.id === 'done');
            const doneBox = createDoneBox(doneCol);
            wrapper.appendChild(doneBox);
            
            // –ö–æ–ª–æ–Ω–∫–∞ "–ü–æ–¥–≤–∏—Å–ª–æ" —Å–Ω–∏–∑—É
            const stuckCol = createColumn(col);
            wrapper.appendChild(stuckCol);
            
            boardEl.appendChild(wrapper);
        } 
        // –î–ª—è "inprogress" —Å–æ–∑–¥–∞—ë–º –æ–±—ë—Ä—Ç–∫—É —Å–æ stats-box —Å–Ω–∏–∑—É
        else if (col.id === 'inprogress') {
            const wrapper = document.createElement('div');
            wrapper.className = 'inprogress-wrapper';
            
            // –ö–æ–ª–æ–Ω–∫–∞ "–í —Ä–∞–±–æ—Ç–µ" —Å–≤–µ—Ä—Ö—É
            const inprogressCol = createColumn(col);
            wrapper.appendChild(inprogressCol);
            
            // –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–Ω–∏–∑—É
            const statsBox = createStatsBox();
            wrapper.appendChild(statsBox);
            
            boardEl.appendChild(wrapper);
        } 
        else {
            const colEl = createColumn(col);
            boardEl.appendChild(colEl);
        }
    });

    updateColumnCounts();
}

function createDoneBox(col) {
    ensureTasksOrderForColumn('done');
    
    const doneBox = document.createElement('div');
    doneBox.className = 'done-box';
    doneBox.dataset.id = 'done';

    doneBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (!dragTaskId) return;
        dragOverColumnId = 'done';

        const body = doneBox.querySelector('.column-body');
        if (!dragPlaceholder) {
            dragPlaceholder = document.createElement('div');
            dragPlaceholder.className = 'card-placeholder';
        }
        body.appendChild(dragPlaceholder);
    });

    doneBox.addEventListener('drop', (e) => {
        e.preventDefault();
        if (!dragTaskId) return;

        handleDropTask(dragTaskId, 'done', null, e);

        if (dragPlaceholder) {
            dragPlaceholder.remove();
            dragPlaceholder = null;
        }
    });

    const header = document.createElement('div');
    header.className = 'column-header';
    const title = document.createElement('div');
    title.className = 'column-title';
    title.textContent = col.title;
    const count = document.createElement('div');
    count.className = 'column-count';
    header.appendChild(title);
    header.appendChild(count);

    const body = document.createElement('div');
    body.className = 'column-body';

    const order = state.tasksOrder['done'] || [];
    const tasksInColumn = state.tasks.filter(t => t.columnId === 'done' && !t.archivedAt);
    const ordered = tasksInColumn.sort((a, b) => {
        const ia = order.indexOf(a.id);
        const ib = order.indexOf(b.id);
        if (ia === -1 && ib === -1) return a.createdAt - b.createdAt;
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–¥–∞—á—É (–æ–Ω–∞ —Å–∫–æ—Ä–æ —É–π–¥—ë—Ç –≤ –∞—Ä—Ö–∏–≤)
    if (ordered.length > 0) {
        body.appendChild(renderCard(ordered[ordered.length - 1]));
    }

    doneBox.appendChild(header);
    doneBox.appendChild(body);

    return doneBox;
}

function createColumn(col) {
    const colEl = document.createElement('div');
    colEl.className = 'column';
    colEl.dataset.id = col.id;

    colEl.addEventListener('click', (e) => {
        const target = e.target;
        if (target.closest('button') || target.closest('.card') || target.closest('[contenteditable]')) return;
        createTaskInColumn(col.id);
    });

    colEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (!dragTaskId) return;
        dragOverColumnId = col.id;

        const body = colEl.querySelector('.column-body');
        const afterElement = getDragAfterElement(body, e.clientY);

        if (!dragPlaceholder) {
            dragPlaceholder = document.createElement('div');
            dragPlaceholder.className = 'card-placeholder';
        }

        if (afterElement == null) {
            body.appendChild(dragPlaceholder);
        } else {
            body.insertBefore(dragPlaceholder, afterElement);
        }
    });

    colEl.addEventListener('drop', (e) => {
        e.preventDefault();
        if (!dragTaskId) return;

        const body = colEl.querySelector('.column-body');
        let beforeTaskId = null;

        if (dragPlaceholder) {
            const next = dragPlaceholder.nextElementSibling;
            if (next && next.classList.contains('card')) {
                beforeTaskId = next.dataset.id;
            }
        }

        handleDropTask(dragTaskId, col.id, beforeTaskId, e);

        if (dragPlaceholder) {
            dragPlaceholder.remove();
            dragPlaceholder = null;
        }
    });

    const header = document.createElement('div');
    header.className = 'column-header';
    const title = document.createElement('div');
    title.className = 'column-title';
    title.textContent = col.title;
    const count = document.createElement('div');
    count.className = 'column-count';
    header.appendChild(title);
    header.appendChild(count);

    const body = document.createElement('div');
    body.className = 'column-body';

    const order = state.tasksOrder[col.id] || [];
    const tasksInColumn = state.tasks.filter(t => t.columnId === col.id && !t.archivedAt);
    const ordered = tasksInColumn.sort((a, b) => {
        const ia = order.indexOf(a.id);
        const ib = order.indexOf(b.id);
        if (ia === -1 && ib === -1) return a.createdAt - b.createdAt;
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
    });

    ordered.forEach(t => body.appendChild(renderCard(t)));

    const addBtn = document.createElement('button');
    addBtn.className = 'add-task-btn';
    addBtn.textContent = '+–ó–∞–¥–∞—á–∞';
    addBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        createTaskInColumn(col.id);
    });

    colEl.appendChild(header);
    colEl.appendChild(body);
    colEl.appendChild(addBtn);

    return colEl;
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];

    let closest = { offset: Number.NEGATIVE_INFINITY, element: null };

    draggableElements.forEach(child => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            closest.offset = offset;
            closest.element = child;
        }
    });

    return closest.element;
}

function createTaskInColumn(columnId) {
    const id = 't_' + Math.random().toString(36).slice(2, 8);
    const task = {
        id,
        columnId,
        title: '',
        description: '',
        priority: 'low',
        dueDate: '',
        tags: '',
        subtasks: [],
        createdAt: Date.now(),
        archivedAt: null
    };
    state.tasks.push(task);
    ensureTasksOrderForColumn(columnId);
    state.tasksOrder[columnId].push(id);
    saveState();

    setTimeout(() => {
        const newCard = document.querySelector(`.card[data-id="${id}"]`);
        if (newCard) {
            const titleEl = newCard.querySelector('.title');
            if (titleEl) {
                titleEl.focus();
            }
            newCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }, 80);
}

/* –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –±–ª–æ–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
function createStatsBox() {
    checkStatsReset();
    
    const statsBox = document.createElement('div');
    statsBox.className = 'stats-box';
    
    statsBox.addEventListener('click', () => {
        const rect = statsBox.getBoundingClientRect();
        const x = rect.left + rect.width / 2;
        const y = rect.top + rect.height / 2;
        playTripleCelebration(x, y);
    });
    
    const title = document.createElement('div');
    title.className = 'stats-title';
    title.textContent = '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è';
    
    const line1 = document.createElement('div');
    line1.className = 'stats-line';
    line1.textContent = `–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á: ${todayStats.tasksCompleted}`;
    
    const line2 = document.createElement('div');
    line2.className = 'stats-line';
    line2.textContent = `–í —Ç–æ–º —á–∏—Å–ª–µ –ø–æ–¥–∑–∞–¥–∞—á: ${todayStats.subtasksCompleted}`;
    
    statsBox.appendChild(title);
    statsBox.appendChild(line1);
    statsBox.appendChild(line2);
    
    return statsBox;
}


/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-12: –†–ï–ù–î–ï–† –ê–†–•–ò–í–ê
   ============================================ */
function renderArchive() {
    archiveListEl.innerHTML = '';

    if (!state.archive.length) {
        const empty = document.createElement('div');
        empty.style.fontSize = '16px';
        empty.style.color = '#6b7280';
        empty.textContent = '–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç';
        archiveListEl.appendChild(empty);
    } else {
        state.archive.forEach(task => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.cursor = 'default';

            const title = document.createElement('div');
            title.className = 'title';
            title.textContent = task.title;

            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = 'space-between';
            row.style.alignItems = 'center';
            row.style.marginTop = '6px';

            const info = document.createElement('div');
            info.className = 'archive-badge';
            const d = new Date(task.archivedAt || Date.now());
            const daysLeft = Math.max(0, APPCONFIG.archiveAutoDeleteDays - Math.floor((Date.now() - task.archivedAt) / (24*60*60*1000)));
            info.textContent = `${d.toLocaleDateString('ru-RU')} (${daysLeft}–¥)`;

            const btnGroup = document.createElement('div');
            btnGroup.style.display = 'flex';
            btnGroup.style.gap = '8px';
            btnGroup.style.alignItems = 'center';

            const restore = document.createElement('button');
            restore.className = 'mini-btn';
            restore.textContent = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            restore.addEventListener('click', () => restoreTask(task.id));

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'archive-delete-btn';
            deleteBtn.textContent = '√ó';
            deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
            deleteBtn.addEventListener('click', () => deleteArchivedTask(task.id));

            btnGroup.appendChild(restore);
            btnGroup.appendChild(deleteBtn);

            row.appendChild(info);
            row.appendChild(btnGroup);

            card.appendChild(title);
            card.appendChild(row);
            archiveListEl.appendChild(card);
        });
    }

    archiveCountEl.textContent = state.archive.length;
}

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-13: –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ê–†–•–ò–í–ê
   ============================================ */
document.getElementById('archiveToggle').addEventListener('click', () => {
    archiveOverlay.classList.add('open');
    renderArchive();
});

document.getElementById('closeArchiveBtn').addEventListener('click', () => {
    archiveOverlay.classList.remove('open');
});

document.getElementById('clearArchiveBtn').addEventListener('click', async () => {
    const yes = await openConfirm('–û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏–≤?', '–í—Å–µ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.');
    if (yes) {
        state.archive = [];
        saveState();
        showToast('–ê—Ä—Ö–∏–≤ –æ—á–∏—â–µ–Ω');
    }
});

document.getElementById('undoDeleteBtn').addEventListener('click', undoDeleteTask);

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-14: –≠–ö–°–ü–û–†–¢/–ò–ú–ü–û–†–¢
   ============================================ */
function exportToFile(auto = false) {
    const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(state, null, 2));
    const a = document.createElement('a');
    const date = new Date();
    const dateStr = date.toISOString().slice(0, 10);
    const timeSuffix = auto ? '-auto' : '-manual';
    a.href = dataStr;
    a.download = `kanban-${dateStr}${timeSuffix}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    localStorage.setItem(LAST_EXPORT_KEY, dateStr);
    if (!auto) showToast('–≠–∫—Å–ø–æ—Ä—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    else showToast('–ê–≤—Ç–æ—ç–∫—Å–ø–æ—Ä—Ç');
}

document.getElementById('exportBtn').addEventListener('click', () => exportToFile(false));

document.getElementById('importBtn').addEventListener('click', () => {
    fileInput.value = '';
    fileInput.click();
});

fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            if (!imported.columns || !imported.tasks || !imported.archive) {
                throw new Error('bad');
            }
            state = imported;
            if (!state.tasksOrder) state.tasksOrder = {};
            state.columns = APPCONFIG.columns.map(c => ({ ...c }));
            saveState();
            showToast('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
        } catch (err) {
            alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
        }
    };
    reader.readAsText(file);
});

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-15: –ê–í–¢–û–≠–ö–°–ü–û–†–¢
   ============================================ */
function scheduleDailyAutoExport() {
    function checkAndSchedule() {
        const now = new Date();
        const currentDateStr = now.toISOString().slice(0, 10);
        const lastExport = localStorage.getItem(LAST_EXPORT_KEY);
        const target = new Date(now);
        target.setHours(23, 59, 0, 0);

        if (now < target && lastExport !== currentDateStr) {
            exportToFile(true);
        }

        const next = new Date(now);
        if (now < target) {
            next.setHours(23, 59, 0, 0);
        } else {
            next.setDate(now.getDate() + 1);
            next.setHours(23, 59, 0, 0);
        }
        const delay = next - now;
        setTimeout(checkAndSchedule, delay);
    }
    checkAndSchedule();
}

/* ============================================
   –ë–õ–û–ö –î–ñ–ê–í–ê-16: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
   ============================================ */
renderBoard();
scheduleDailyAutoExport();
    </script>
</body>
</html>
